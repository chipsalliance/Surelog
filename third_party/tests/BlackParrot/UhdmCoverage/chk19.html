
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>./bp_be/src/v/bp_be_mem/bp_be_dcache/bp_be_dcache_lce_cmd.v Cov: 97% </h3>
<pre style="margin:0; padding:0 ">   1: /**</pre>
<pre style="margin:0; padding:0 ">   2:  *  Name:</pre>
<pre style="margin:0; padding:0 ">   3:  *    bp_be_dcache_lce_cmd.v</pre>
<pre style="margin:0; padding:0 ">   4:  *</pre>
<pre style="margin:0; padding:0 ">   5:  *  Description:</pre>
<pre style="margin:0; padding:0 ">   6:  *    LCE command handler. On reset, LCE is in reset state, waiting to be</pre>
<pre style="margin:0; padding:0 ">   7:  *    initialized. LCE receives set_clear commands to invalidate all the sets</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   8:  *    in the cache. Once LCE has received sync command from all the CCEs, and</pre>
<pre id="id9" style="background-color: #FFB6C1; margin:0; padding:0 ">   9:  *    has responded with ack, it asserts lce_sync_done_o signal to indicate</pre>
<pre id="id10" style="background-color: #FFB6C1; margin:0; padding:0 ">  10:  *    that the cache may begin start accepting load/store instructions from</pre>
<pre style="margin:0; padding:0 ">  11:  *    the backend.</pre>
<pre style="margin:0; padding:0 ">  12:  *</pre>
<pre style="margin:0; padding:0 ">  13:  */</pre>
<pre style="margin:0; padding:0 ">  14: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  15: module bp_be_dcache_lce_cmd</pre>
<pre style="margin:0; padding:0 ">  16:   import bp_common_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  17:   import bp_be_dcache_pkg::*;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18:   #(parameter num_cce_p="inv"</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  19:     , parameter num_lce_p="inv"</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  20:     , parameter paddr_width_p="inv"</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  21:     , parameter lce_data_width_p="inv"</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  22:     , parameter sets_p="inv"</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  23:     , parameter ways_p="inv"</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  24:     , parameter data_width_p="inv"</pre>
<pre style="margin:0; padding:0 ">  25: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  26:     , localparam block_size_in_words_lp=ways_p</pre>
<pre style="margin:0; padding:0 ">  27:     , localparam data_mask_width_lp=(data_width_p>>3)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  28:     , localparam byte_offset_width_lp=`BSG_SAFE_CLOG2(data_width_p>>3)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  29:     , localparam word_offset_width_lp=`BSG_SAFE_CLOG2(block_size_in_words_lp)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  30:     , localparam block_offset_width_lp=(word_offset_width_lp+byte_offset_width_lp)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  31:     , localparam index_width_lp=`BSG_SAFE_CLOG2(sets_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  32:     , localparam tag_width_lp=(paddr_width_p-index_width_lp-block_offset_width_lp)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:     , localparam way_id_width_lp=`BSG_SAFE_CLOG2(ways_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34:     , localparam lce_id_width_lp=`BSG_SAFE_CLOG2(num_lce_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  35:     , localparam cce_id_width_lp=`BSG_SAFE_CLOG2(num_cce_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  36:     </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  37:     `declare_bp_lce_cce_if_widths(num_cce_p, num_lce_p, paddr_width_p, ways_p, data_width_p, lce_data_width_p) </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  38: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:     , localparam dcache_lce_data_mem_pkt_width_lp=</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  40:       `bp_be_dcache_lce_data_mem_pkt_width(sets_p, ways_p, lce_data_width_p)</pre>
<pre style="margin:0; padding:0 ">  41:     , localparam dcache_lce_tag_mem_pkt_width_lp=</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  42:       `bp_be_dcache_lce_tag_mem_pkt_width(sets_p, ways_p, tag_width_lp)</pre>
<pre style="margin:0; padding:0 ">  43:     , localparam dcache_lce_stat_mem_pkt_width_lp=</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:       `bp_be_dcache_lce_stat_mem_pkt_width(sets_p, ways_p)</pre>
<pre style="margin:0; padding:0 ">  45:   )</pre>
<pre style="margin:0; padding:0 ">  46:   (</pre>
<pre style="margin:0; padding:0 ">  47:     input clk_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:     , input reset_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  49:     , input freeze_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  50: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:     , input [lce_id_width_lp-1:0] lce_id_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52: </pre>
<pre style="margin:0; padding:0 ">  53:     , input bp_be_dcache_lce_mode_e lce_mode_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  54: </pre>
<pre style="margin:0; padding:0 ">  55:     , input [paddr_width_p-1:0] miss_addr_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  56: </pre>
<pre style="margin:0; padding:0 ">  57:     , output logic lce_sync_done_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  58:     , output logic set_tag_received_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59:     , output logic set_tag_wakeup_received_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  60:     , output logic uncached_store_done_received_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:     , output logic cce_data_received_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  62:     , output logic uncached_data_received_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63: </pre>
<pre style="margin:0; padding:0 ">  64:     // CCE_LCE_cmd</pre>
<pre style="margin:0; padding:0 ">  65:     , input [lce_cmd_width_lp-1:0] lce_cmd_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:     , input lce_cmd_v_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  67:     , output logic lce_cmd_ready_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  68: </pre>
<pre style="margin:0; padding:0 ">  69:     // LCE_CCE_resp</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  70:     , output logic [lce_cce_resp_width_lp-1:0] lce_resp_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  71:     , output logic lce_resp_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  72:     , input lce_resp_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  73: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:     // LCE_data_cmd_out</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  75:     , output logic [lce_cmd_width_lp-1:0] lce_cmd_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  76:     , output logic lce_cmd_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  77:     , input lce_cmd_ready_i </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  78: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  79:     // data_mem</pre>
<pre style="margin:0; padding:0 ">  80:     , output logic data_mem_pkt_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  81:     , output logic [dcache_lce_data_mem_pkt_width_lp-1:0] data_mem_pkt_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  82:     , input [lce_data_width_p-1:0] data_mem_data_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  83:     , input data_mem_pkt_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  84:   </pre>
<pre style="margin:0; padding:0 ">  85:     // tag_mem</pre>
<pre style="margin:0; padding:0 ">  86:     , output logic tag_mem_pkt_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:     , output logic [dcache_lce_tag_mem_pkt_width_lp-1:0] tag_mem_pkt_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:     , input tag_mem_pkt_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  89:     </pre>
<pre style="margin:0; padding:0 ">  90:     // stat_mem</pre>
<pre style="margin:0; padding:0 ">  91:     , output logic stat_mem_pkt_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  92:     , output logic [dcache_lce_stat_mem_pkt_width_lp-1:0] stat_mem_pkt_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  93:     , input [ways_p-1:0] dirty_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:     , input stat_mem_pkt_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95:   );</pre>
<pre style="margin:0; padding:0 ">  96: </pre>
<pre style="margin:0; padding:0 ">  97:   // casting structs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  98:   `declare_bp_lce_cce_if(num_cce_p, num_lce_p, paddr_width_p, ways_p, data_width_p, lce_data_width_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  99:   `declare_bp_be_dcache_lce_data_mem_pkt_s(sets_p, ways_p, lce_data_width_p);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 100:   `declare_bp_be_dcache_lce_tag_mem_pkt_s(sets_p, ways_p, tag_width_lp);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 101:   `declare_bp_be_dcache_lce_stat_mem_pkt_s(sets_p, ways_p);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 102: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 103:   bp_lce_cmd_s lce_cmd_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:   logic lce_cmd_v_li, lce_cmd_yumi_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 105:   bp_lce_cce_resp_s lce_resp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 106:   bp_lce_cmd_s lce_cmd_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 107: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 108:   assign lce_resp_o = lce_resp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 109:   assign lce_cmd_o = lce_cmd_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110: </pre>
<pre style="margin:0; padding:0 "> 111:   bp_be_dcache_lce_data_mem_pkt_s data_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 112:   bp_be_dcache_lce_tag_mem_pkt_s tag_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 113:   bp_be_dcache_lce_stat_mem_pkt_s stat_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 115:   assign data_mem_pkt_o = data_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 116:   assign tag_mem_pkt_o = tag_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 117:   assign stat_mem_pkt_o = stat_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 118: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 119:   logic [index_width_lp-1:0] lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 120:   logic [tag_width_lp-1:0] lce_cmd_addr_tag;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 122:   assign lce_cmd_addr_index = lce_cmd_li.msg.cmd.addr[block_offset_width_lp+:index_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 123:   assign lce_cmd_addr_tag = lce_cmd_li.msg.cmd.addr[block_offset_width_lp+index_width_lp+:tag_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 124: </pre>
<pre style="margin:0; padding:0 "> 125: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 126:   // states</pre>
<pre style="margin:0; padding:0 "> 127:   //</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 128:   typedef enum logic [2:0] {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 129:     e_lce_cmd_state_uncached</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 130:     ,e_lce_cmd_state_sync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 131:     ,e_lce_cmd_state_ready</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 132:     ,e_lce_cmd_state_tr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:     ,e_lce_cmd_state_wb</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 134:     ,e_lce_cmd_state_wb_dirty</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:     ,e_lce_cmd_state_wb_not_dirty</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:   } lce_cmd_state_e;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 137: </pre>
<pre style="margin:0; padding:0 "> 138:   lce_cmd_state_e state_r, state_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 139:   logic [cce_id_width_lp-1:0] sync_ack_count_r, sync_ack_count_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 140: </pre>
<pre style="margin:0; padding:0 "> 141:   // for invalidate_tag_cmd</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 142:   logic invalidated_tag_r, invalidated_tag_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:   // for transfer_cmd</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145:   logic tr_data_buffered_r, tr_data_buffered_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 146: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 147:   // for writeback_cmd</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:   logic wb_data_buffered_r, wb_data_buffered_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:   logic wb_data_read_r, wb_data_read_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 150:   logic wb_dirty_cleared_r, wb_dirty_cleared_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 151: </pre>
<pre style="margin:0; padding:0 "> 152:   // data buffer</pre>
<pre style="margin:0; padding:0 "> 153:   logic [lce_data_width_p-1:0] data_buf_r, data_buf_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 154: </pre>
<pre style="margin:0; padding:0 "> 155:   // transaction signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 156:   //</pre>
<pre style="margin:0; padding:0 "> 157:   logic lce_resp_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 158:   logic lce_tr_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 159:   </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 160:   assign lce_tr_done = lce_cmd_v_o & lce_cmd_ready_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 161:   assign lce_resp_done = lce_resp_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 162: </pre>
<pre style="margin:0; padding:0 "> 163:   // this gets asserted when LCE finishes its sync with CCE.</pre>
<pre style="margin:0; padding:0 "> 164:   assign lce_sync_done_o = (state_r != e_lce_cmd_state_sync)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 165:                            & (state_r != e_lce_cmd_state_uncached);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 166: </pre>
<pre style="margin:0; padding:0 "> 167:   // next state logic</pre>
<pre style="margin:0; padding:0 "> 168:   //</pre>
<pre style="margin:0; padding:0 "> 169:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:     </pre>
<pre style="margin:0; padding:0 "> 171:     state_n = state_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 172:     sync_ack_count_n = sync_ack_count_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 173:     tr_data_buffered_n = tr_data_buffered_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 174: </pre>
<pre style="margin:0; padding:0 "> 175:     wb_data_buffered_n = wb_data_buffered_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 176:     wb_data_read_n = wb_data_read_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 177:     wb_dirty_cleared_n = wb_dirty_cleared_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 178: </pre>
<pre style="margin:0; padding:0 "> 179:     invalidated_tag_n = invalidated_tag_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 180: </pre>
<pre style="margin:0; padding:0 "> 181:     data_buf_n = data_buf_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 182: </pre>
<pre style="margin:0; padding:0 "> 183:     set_tag_received_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:     set_tag_wakeup_received_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:     uncached_store_done_received_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 186:     uncached_data_received_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:     cce_data_received_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188: </pre>
<pre style="margin:0; padding:0 "> 189:     lce_cmd_yumi_lo = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 190: </pre>
<pre style="margin:0; padding:0 "> 191:     lce_resp = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 192:     lce_resp_v_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 193: </pre>
<pre style="margin:0; padding:0 "> 194:     lce_cmd_out = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 195:     lce_cmd_v_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196: </pre>
<pre style="margin:0; padding:0 "> 197:     data_mem_pkt = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 198:     data_mem_pkt_v_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:     tag_mem_pkt = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:     tag_mem_pkt_v_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 201:     stat_mem_pkt = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 202:     stat_mem_pkt_v_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:     </pre>
<pre style="margin:0; padding:0 "> 204:     unique case (state_r)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 205: </pre>
<pre style="margin:0; padding:0 "> 206:       // < STARTUP / UNCACHED ONLY ></pre>
<pre style="margin:0; padding:0 "> 207:       // LCE starts in a mode that can process only uncached accesses, and in which the only</pre>
<pre style="margin:0; padding:0 "> 208:       // commands that will be received are uncached store done commands. When freeze_i goes low</pre>
<pre style="margin:0; padding:0 "> 209:       // the LCE makes a determination how to operate based on the value of the LCE mode register.</pre>
<pre style="margin:0; padding:0 "> 210:       // If the mode is set to uncached, the LCE CMD unit stays in this state. If the mode is</pre>
<pre style="margin:0; padding:0 "> 211:       // set to normal, the LCE CMD unit transitions to the sync state and waits for the CCE to</pre>
<pre style="margin:0; padding:0 "> 212:       // perform the initialization routine.</pre>
<pre style="margin:0; padding:0 "> 213:       e_lce_cmd_state_uncached: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 214:         state_n = (freeze_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 215:                   ? e_lce_cmd_state_uncached</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 216:                   : (lce_mode_i == e_dcache_lce_mode_normal)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 217:                     ? e_lce_cmd_state_sync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 218:                     : e_lce_cmd_state_uncached;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 219: </pre>
<pre style="margin:0; padding:0 "> 220:         if (lce_cmd_v_li) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221:           unique case (lce_cmd_li.msg_type)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 222:             //  <uncached store done></pre>
<pre style="margin:0; padding:0 "> 223:             //  Uncached store done from CCE - decrement flow counter</pre>
<pre style="margin:0; padding:0 "> 224:             e_lce_cmd_uc_st_done: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 225:               lce_cmd_yumi_lo = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 226:               uncached_store_done_received_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 227:             end</pre>
<pre style="margin:0; padding:0 "> 228: </pre>
<pre style="margin:0; padding:0 "> 229:             // for other message types in this state, use default as defined at top.</pre>
<pre style="margin:0; padding:0 "> 230:             default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 231:             end</pre>
<pre style="margin:0; padding:0 "> 232:           endcase</pre>
<pre style="margin:0; padding:0 "> 233:         end</pre>
<pre style="margin:0; padding:0 "> 234: </pre>
<pre style="margin:0; padding:0 "> 235:       end</pre>
<pre style="margin:0; padding:0 "> 236: </pre>
<pre style="margin:0; padding:0 "> 237:       // < RESET ></pre>
<pre style="margin:0; padding:0 "> 238:       // LCE is expected to receive SET-CLEAR messages from CCE to invalidate every cache lines.</pre>
<pre style="margin:0; padding:0 "> 239:       // set-clear messages clears the valid bits in tag_mem and the dirty bits in stat_mem.</pre>
<pre style="margin:0; padding:0 "> 240:       // When LCE receives SYNC message, it responds with SYNC-ACK. When LCE received SYNC messages from</pre>
<pre style="margin:0; padding:0 "> 241:       // every CCE in the system, it moves onto READY state.</pre>
<pre style="margin:0; padding:0 "> 242:       e_lce_cmd_state_sync: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 243:         if (lce_cmd_v_li) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 244:           unique case (lce_cmd_li.msg_type)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245: </pre>
<pre style="margin:0; padding:0 "> 246:             e_lce_cmd_sync: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:               lce_resp.dst_id = lce_cmd_li.msg.cmd.src_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 248:               lce_resp.src_id = lce_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 249:               lce_resp.msg_type = e_lce_cce_sync_ack;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 250:               lce_resp_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 251:               lce_cmd_yumi_lo = lce_resp_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252:               sync_ack_count_n = lce_resp_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:                 ? sync_ack_count_r + 1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:                 : sync_ack_count_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 255:               state_n = ((sync_ack_count_r == cce_id_width_lp'(num_cce_p-1)) & lce_resp_yumi_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 256:                 ? e_lce_cmd_state_ready</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 257:                 : e_lce_cmd_state_sync;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:             end</pre>
<pre style="margin:0; padding:0 "> 259: </pre>
<pre style="margin:0; padding:0 "> 260:             e_lce_cmd_set_clear: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 261:               tag_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 262:               tag_mem_pkt.opcode = e_dcache_lce_tag_mem_set_clear;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:               tag_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264: </pre>
<pre style="margin:0; padding:0 "> 265:               stat_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 266:               stat_mem_pkt.opcode = e_dcache_lce_stat_mem_set_clear;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 267:               stat_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 268: </pre>
<pre style="margin:0; padding:0 "> 269:               lce_cmd_yumi_lo = tag_mem_pkt_yumi_i & stat_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 270:             end</pre>
<pre style="margin:0; padding:0 "> 271:   </pre>
<pre style="margin:0; padding:0 "> 272:             // for other message types in this state, use default as defined at top.</pre>
<pre style="margin:0; padding:0 "> 273:             default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 274: 	       </pre>
<pre style="margin:0; padding:0 "> 275:             end</pre>
<pre style="margin:0; padding:0 "> 276:           endcase </pre>
<pre style="margin:0; padding:0 "> 277:         end</pre>
<pre style="margin:0; padding:0 "> 278:       end</pre>
<pre style="margin:0; padding:0 "> 279: </pre>
<pre style="margin:0; padding:0 "> 280:       // < READY ></pre>
<pre style="margin:0; padding:0 "> 281:       // LCE is ready to process cce_lce_cmd packets. In general, the packets are dequeued, when LCE</pre>
<pre style="margin:0; padding:0 "> 282:       // has finished with the job related to the packet.</pre>
<pre style="margin:0; padding:0 "> 283:       e_lce_cmd_state_ready: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 284:         if (lce_cmd_v_li) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 285:           unique case (lce_cmd_li.msg_type)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 286:             // <transfer packet></pre>
<pre style="margin:0; padding:0 "> 287:             // LCE first reads the data mem, and moves onto TRANSFER state.</pre>
<pre style="margin:0; padding:0 "> 288:             e_lce_cmd_transfer: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 289:               data_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:               data_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 291:               data_mem_pkt.opcode = e_dcache_lce_data_mem_read;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 292:               data_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 293: </pre>
<pre style="margin:0; padding:0 "> 294:               state_n = data_mem_pkt_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 295:                 ? e_lce_cmd_state_tr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 296:                 : e_lce_cmd_state_ready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 297:             end</pre>
<pre style="margin:0; padding:0 "> 298: </pre>
<pre style="margin:0; padding:0 "> 299:             //  <writeback packet></pre>
<pre style="margin:0; padding:0 "> 300:             //  LCE is asked to writeback a cache line.</pre>
<pre style="margin:0; padding:0 "> 301:             //  It first reads stat_mem to check if the line is dirty.</pre>
<pre id="id302" style="background-color: #FFB6C1; margin:0; padding:0 "> 302:             e_lce_cmd_writeback: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 303:               stat_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 304:               stat_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 305:               stat_mem_pkt.opcode = e_dcache_lce_stat_mem_read;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 306:               stat_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 307: </pre>
<pre style="margin:0; padding:0 "> 308:               state_n = stat_mem_pkt_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 309:                 ? e_lce_cmd_state_wb</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 310:                 : e_lce_cmd_state_ready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:             end</pre>
<pre style="margin:0; padding:0 "> 312: </pre>
<pre id="id313" style="background-color: #FFB6C1; margin:0; padding:0 "> 313:             //  <set tag></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 314:             //  set the tag and coherency state of given index/way.</pre>
<pre style="margin:0; padding:0 "> 315:             e_lce_cmd_set_tag: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 316:               tag_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:               tag_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 318:               tag_mem_pkt.state = lce_cmd_li.msg.cmd.state;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319:               tag_mem_pkt.tag = lce_cmd_addr_tag;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 320:               tag_mem_pkt.opcode = e_dcache_lce_tag_mem_set_tag;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 321:               tag_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322: </pre>
<pre id="id323" style="background-color: #FFB6C1; margin:0; padding:0 "> 323:               lce_cmd_yumi_lo = tag_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 324: </pre>
<pre id="id325" style="background-color: #FFB6C1; margin:0; padding:0 "> 325:               set_tag_received_o = tag_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 326:             end</pre>
<pre style="margin:0; padding:0 "> 327: </pre>
<pre style="margin:0; padding:0 "> 328:             //  <set tag wakeup></pre>
<pre style="margin:0; padding:0 "> 329:             //  set the tag and send wake-up signal to lce_cce_req module.</pre>
<pre style="margin:0; padding:0 "> 330:             e_lce_cmd_set_tag_wakeup: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:               tag_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:               tag_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 333:               tag_mem_pkt.state = lce_cmd_li.msg.cmd.state;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 334:               tag_mem_pkt.tag = lce_cmd_addr_tag;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 335:               tag_mem_pkt.opcode = e_dcache_lce_tag_mem_set_tag;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336:               tag_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 337: </pre>
<pre style="margin:0; padding:0 "> 338:               lce_cmd_yumi_lo = tag_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 339: </pre>
<pre style="margin:0; padding:0 "> 340:               set_tag_wakeup_received_o = tag_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 341:             end</pre>
<pre style="margin:0; padding:0 "> 342: </pre>
<pre id="id343" style="background-color: #FFB6C1; margin:0; padding:0 "> 343:             //  <invalidate tag></pre>
<pre id="id344" style="background-color: #FFB6C1; margin:0; padding:0 "> 344:             //  invalidate tag. It does not update the LRU. It sends out</pre>
<pre style="margin:0; padding:0 "> 345:             //  invalidate_ack response.</pre>
<pre style="margin:0; padding:0 "> 346:             e_lce_cmd_invalidate_tag: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 347:               tag_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 348:               tag_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 349:               tag_mem_pkt.opcode = e_dcache_lce_tag_mem_invalidate;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 350:               tag_mem_pkt_v_o = invalidated_tag_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 351:                 ? 1'b0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352:                 : lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 353:               invalidated_tag_n = lce_resp_yumi_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 354:                 ? 1'b0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:                 : (invalidated_tag_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 356:                   ? 1'b1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 357:                   : tag_mem_pkt_yumi_i);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358: </pre>
<pre style="margin:0; padding:0 "> 359:               lce_resp.dst_id = lce_cmd_li.msg.cmd.src_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:               lce_resp.msg_type = e_lce_cce_inv_ack;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:               lce_resp.src_id = lce_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 362:               lce_resp.addr = lce_cmd_li.msg.cmd.addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 363:               lce_resp_v_o = invalidated_tag_r | tag_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:               lce_cmd_yumi_lo = lce_resp_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 365:             end</pre>
<pre style="margin:0; padding:0 "> 366: </pre>
<pre style="margin:0; padding:0 "> 367:             //  <uncached store done></pre>
<pre style="margin:0; padding:0 "> 368:             //  Uncached store done from CCE - decrement flow counter</pre>
<pre style="margin:0; padding:0 "> 369:             e_lce_cmd_uc_st_done: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 370:               lce_cmd_yumi_lo = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 371:               uncached_store_done_received_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 372:             end</pre>
<pre style="margin:0; padding:0 "> 373: </pre>
<pre style="margin:0; padding:0 "> 374:             e_lce_cmd_data: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 375:               data_mem_pkt.index = miss_addr_i[block_offset_width_lp+:index_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:               data_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 377:               data_mem_pkt.data = lce_cmd_li.msg.dt_cmd.data;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 378:               data_mem_pkt.opcode = e_dcache_lce_data_mem_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:               data_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380: </pre>
<pre style="margin:0; padding:0 "> 381:               tag_mem_pkt.index = miss_addr_i[block_offset_width_lp+:index_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382:               tag_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 383:               tag_mem_pkt.state = lce_cmd_li.msg.dt_cmd.state;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 384:               tag_mem_pkt.tag = lce_cmd_li.msg.dt_cmd.addr[block_offset_width_lp+index_width_lp+:tag_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 385:               tag_mem_pkt.opcode = e_dcache_lce_tag_mem_set_tag;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 386:               tag_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387: </pre>
<pre style="margin:0; padding:0 "> 388:               lce_cmd_yumi_lo     = tag_mem_pkt_yumi_i & data_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 389: </pre>
<pre style="margin:0; padding:0 "> 390:               cce_data_received_o = tag_mem_pkt_yumi_i & data_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:               set_tag_received_o  = tag_mem_pkt_yumi_i & data_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 392: </pre>
<pre style="margin:0; padding:0 "> 393:             end</pre>
<pre style="margin:0; padding:0 "> 394: </pre>
<pre style="margin:0; padding:0 "> 395:             e_lce_cmd_uc_data: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 396:               data_mem_pkt.index = miss_addr_i[block_offset_width_lp+:index_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 397:               data_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 398:               data_mem_pkt.data = lce_cmd_li.msg.dt_cmd.data;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 399:               data_mem_pkt.opcode = e_dcache_lce_data_mem_uncached;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 400:               data_mem_pkt_v_o = lce_cmd_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 401:               lce_cmd_yumi_lo = data_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 402: </pre>
<pre style="margin:0; padding:0 "> 403:               uncached_data_received_o = data_mem_pkt_yumi_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 404:             end</pre>
<pre style="margin:0; padding:0 "> 405:             // for other message types in this state, use default as defined at top.</pre>
<pre style="margin:0; padding:0 "> 406:             default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 407: </pre>
<pre style="margin:0; padding:0 "> 408:             end</pre>
<pre style="margin:0; padding:0 "> 409:           endcase</pre>
<pre style="margin:0; padding:0 "> 410:         end</pre>
<pre style="margin:0; padding:0 "> 411:       end</pre>
<pre style="margin:0; padding:0 "> 412: </pre>
<pre style="margin:0; padding:0 "> 413:       // <TRANSFER state>    </pre>
<pre style="margin:0; padding:0 "> 414:       // First, buffer the data read from data_mem, and try to send transfer to another LCE.</pre>
<pre style="margin:0; padding:0 "> 415:       e_lce_cmd_state_tr: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 416:         data_buf_n = tr_data_buffered_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 417:           ? data_buf_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 418:           : data_mem_data_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 419:         tr_data_buffered_n = ~lce_tr_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 420: </pre>
<pre style="margin:0; padding:0 "> 421:         lce_cmd_out.dst_id = lce_cmd_li.msg.cmd.target;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 422:         lce_cmd_out.msg_type = e_lce_cmd_data;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 423:         lce_cmd_out.way_id = lce_cmd_li.msg.cmd.target_way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 424:         lce_cmd_out.msg.dt_cmd.addr = lce_cmd_li.msg.cmd.addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 425:         lce_cmd_out.msg.dt_cmd.state = lce_cmd_li.msg.cmd.state;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 426:         lce_cmd_out.msg.dt_cmd.data = tr_data_buffered_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 427:           ? data_buf_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 428:           : data_mem_data_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 429:         lce_cmd_v_o = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 430: </pre>
<pre style="margin:0; padding:0 "> 431:         lce_cmd_yumi_lo = lce_tr_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 432:         state_n = lce_tr_done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 433:           ? e_lce_cmd_state_ready</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 434:           : e_lce_cmd_state_tr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 435:       end</pre>
<pre style="margin:0; padding:0 "> 436: </pre>
<pre style="margin:0; padding:0 "> 437:       // <WRITEBACK state></pre>
<pre style="margin:0; padding:0 "> 438:       // Determine if the block is dirty or not.</pre>
<pre style="margin:0; padding:0 "> 439:       e_lce_cmd_state_wb: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 440:         state_n = dirty_i[lce_cmd_li.way_id] </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 441:           ? e_lce_cmd_state_wb_dirty</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 442:           : e_lce_cmd_state_wb_not_dirty;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 443:       end</pre>
<pre style="margin:0; padding:0 "> 444: </pre>
<pre style="margin:0; padding:0 "> 445:       // <WRITEBACK dirty state></pre>
<pre style="margin:0; padding:0 "> 446:       // If the block is dirty, read the block, buffers the data, clear the dirty bit on the block.</pre>
<pre style="margin:0; padding:0 "> 447:       // At last, send out the block data to CCE.</pre>
<pre style="margin:0; padding:0 "> 448:       e_lce_cmd_state_wb_dirty: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 449:         data_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 450:         data_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 451:         data_mem_pkt.opcode = e_dcache_lce_data_mem_read;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 452:         data_mem_pkt_v_o = ~wb_data_read_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 453:         data_buf_n = wb_data_buffered_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 454:           ? data_buf_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 455:           : (wb_data_read_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 456:             ? data_mem_data_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 457:             : data_buf_r);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 458:         wb_data_buffered_n = lce_resp_done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 459:           ? 1'b0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 460:           : (wb_data_buffered_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 461:             ? 1'b1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 462:             : wb_data_read_r);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 463:         wb_data_read_n = lce_resp_done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 464:           ? 1'b0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 465:           : (wb_data_read_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 466:             ? 1'b1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 467:             : data_mem_pkt_yumi_i);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 468: </pre>
<pre style="margin:0; padding:0 "> 469:         stat_mem_pkt.index = lce_cmd_addr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 470:         stat_mem_pkt.way_id = lce_cmd_li.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:         stat_mem_pkt.opcode = e_dcache_lce_stat_mem_clear_dirty;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:         stat_mem_pkt_v_o = wb_dirty_cleared_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:           ? 1'b0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 474:           : (wb_data_read_r | data_mem_pkt_yumi_i);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 475:         wb_dirty_cleared_n = lce_resp_done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 476:           ? 1'b0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 477:           : (wb_dirty_cleared_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 478:             ? 1'b1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 479:             : stat_mem_pkt_yumi_i);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 480:         </pre>
<pre style="margin:0; padding:0 "> 481:         lce_resp.data = wb_data_buffered_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 482:           ? data_buf_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 483:           : data_mem_data_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 484:         lce_resp.addr = lce_cmd_li.msg.cmd.addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 485:         lce_resp.msg_type = e_lce_cce_resp_wb;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 486:         lce_resp.src_id = lce_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 487:         lce_resp.dst_id = lce_cmd_li.msg.cmd.src_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 488:         lce_resp_v_o = wb_data_read_r & (wb_dirty_cleared_r | stat_mem_pkt_yumi_i);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 489: </pre>
<pre style="margin:0; padding:0 "> 490:         lce_cmd_yumi_lo = lce_resp_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 491: </pre>
<pre style="margin:0; padding:0 "> 492:         state_n = lce_resp_done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 493:           ? e_lce_cmd_state_ready</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 494:           : e_lce_cmd_state_wb_dirty;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 495:       end</pre>
<pre style="margin:0; padding:0 "> 496: </pre>
<pre style="margin:0; padding:0 "> 497:       //  <WRITEBACK not-dirty state></pre>
<pre style="margin:0; padding:0 "> 498:       //  If not dirty, just respond with null writeback data.</pre>
<pre style="margin:0; padding:0 "> 499:       e_lce_cmd_state_wb_not_dirty: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 500:         lce_resp.data = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 501:         lce_resp.addr = lce_cmd_li.msg.cmd.addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 502:         lce_resp.msg_type = e_lce_cce_resp_null_wb;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 503:         lce_resp.src_id = lce_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 504:         lce_resp.dst_id = lce_cmd_li.msg.cmd.src_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 505:         lce_resp_v_o = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 506: </pre>
<pre style="margin:0; padding:0 "> 507:         lce_cmd_yumi_lo = lce_resp_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 508: </pre>
<pre style="margin:0; padding:0 "> 509:         state_n = lce_resp_done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 510:           ? e_lce_cmd_state_ready</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 511:           : e_lce_cmd_state_wb_not_dirty;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 512:       end      </pre>
<pre style="margin:0; padding:0 "> 513: </pre>
<pre style="margin:0; padding:0 "> 514:       // we should never get in this state, but if we do, return to the sync state.</pre>
<pre style="margin:0; padding:0 "> 515:       default: begin </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 516:         state_n = e_lce_cmd_state_sync;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 517:       end</pre>
<pre style="margin:0; padding:0 "> 518:     endcase</pre>
<pre style="margin:0; padding:0 "> 519:   end</pre>
<pre style="margin:0; padding:0 "> 520: </pre>
<pre style="margin:0; padding:0 "> 521: </pre>
<pre style="margin:0; padding:0 "> 522:   // sequential logic</pre>
<pre style="margin:0; padding:0 "> 523:   //</pre>
<pre style="margin:0; padding:0 "> 524:   //synopsys sync_set_reset "reset_i"</pre>
<pre style="margin:0; padding:0 "> 525:   always_ff @ (posedge clk_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 526:     if (reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 527:       state_r <= e_lce_cmd_state_uncached;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 528:       sync_ack_count_r <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 529:       tr_data_buffered_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 530:       wb_data_buffered_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 531:       wb_data_read_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 532:       wb_dirty_cleared_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 533:       invalidated_tag_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 534:     end</pre>
<pre style="margin:0; padding:0 "> 535:     else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 536:       state_r <= state_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 537:       sync_ack_count_r <= sync_ack_count_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 538:       tr_data_buffered_r <= tr_data_buffered_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 539:       wb_data_buffered_r <= wb_data_buffered_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 540:       wb_data_read_r <= wb_data_read_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 541:       wb_dirty_cleared_r <= wb_dirty_cleared_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 542:       data_buf_r <= data_buf_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 543:       invalidated_tag_r <= invalidated_tag_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 544:     end</pre>
<pre style="margin:0; padding:0 "> 545:   end</pre>
<pre style="margin:0; padding:0 "> 546: </pre>
<pre style="margin:0; padding:0 "> 547:   // We need this converter because the LCE expects this interface to be valid-yumi, while</pre>
<pre style="margin:0; padding:0 "> 548:   // the network links are ready-and-valid. It's possible that we could modify the LCE to </pre>
<pre style="margin:0; padding:0 "> 549:   // be helpful and avoid this</pre>
<pre style="margin:0; padding:0 "> 550:   bsg_two_fifo </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 551:    #(.width_p(lce_cmd_width_lp))</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 552:    rv_adapter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 553:     (.clk_i(clk_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 554:      ,.reset_i(reset_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 555: </pre>
<pre style="margin:0; padding:0 "> 556:      ,.data_i(lce_cmd_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 557:      ,.v_i(lce_cmd_v_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 558:      ,.ready_o(lce_cmd_ready_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 559: </pre>
<pre style="margin:0; padding:0 "> 560:      ,.data_o(lce_cmd_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 561:      ,.v_o(lce_cmd_v_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 562:      ,.yumi_i(lce_cmd_yumi_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 563:      );</pre>
<pre style="margin:0; padding:0 "> 564: </pre>
<pre style="margin:0; padding:0 "> 565: </pre>
<pre style="margin:0; padding:0 "> 566: endmodule</pre>
<pre style="margin:0; padding:0 "> 567: </pre>
</body>
</html>
